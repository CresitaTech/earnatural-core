$(document).ready(function () {

	var totalAmount = parseFloat(getParameterByName('unitPrice')*getParameterByName('quantity')).toFixed( 2 );



	$("#total_amount_display").html('$'+totalAmount);

	$("#unitPrice").val(getParameterByName('unitPrice'));

	$("#quantity").val(getParameterByName('quantity'));

	$('#buttonAddress').prop('disabled', true);

	$('#buttonAddress').css('background-color', '#6c757d');





	var mastercard = $("#mastercard");

	var visa = $("#visa");

	var discover = $("#discover");

	var amex = $("#amex");



	

	

	var cleaveDate = new Cleave('#inputExpDate', {

		date: true,

		datePattern: ['m', 'y']

	});

	console.log(cleaveDate);

	$('#inputExpDate').on('blur', function(e) {

        var monYr = $('#inputExpDate').val().split("/");

		var currentYear = new Date().getFullYear().toString().substr(-2)

		console.log("==============currentYear:" + currentYear + ' selected: ' + monYr[1]);

		var currentMon = new Date().getMonth().toString()

		if(currentMon < 10){

			currentMon = '0'+currentMon;

		}

		if (monYr[1] >= currentYear) {

			console.log("==============currentMonth:" + currentMon + ' selected: ' + monYr[0]);

			if (monYr[0] >= currentMon) {

			return true; 

			}else{

				$('#inputExpDate').val(currentMon + "/" + currentYear);

			}

			return true; 

		}else{

			

			$('#inputExpDate').val(monYr[0] + "/" + currentYear);

			console.log("==============currentMonth:" + currentMon + ' selected: ' + monYr[0]);

			if (monYr[0] >= currentMon) {

			return true; 

			}else{

				$('#inputExpDate').val(currentMon + "/" + currentYear);

			}

		}

		

    });   

	



	var cleaveCC = new Cleave('#cardNumber', {

		creditCard: true,

		delimiter: '-',

		onCreditCardTypeChanged: function (type) {

			// update UI ...

			console.log(type)

			$.fn.clearCardIcon();

			if (type == 'mastercard' || type == 'visa' || type == 'discover' ) {

				$(`#${type}`).removeClass('transparent');

				console.log('Card type ' + type + ' found')

			}else if (type == 'amex' ) {

				document.getElementById("errorAmericanCard").style.display = 'block';

				document.getElementById("errorAmericanCard").innerHTML = 'We do not accept American Express, please enter any visa, dicover and master card number.';

			}else{

				document.getElementById("errorAmericanCard").style.display = 'block';

				document.getElementById("errorAmericanCard").innerHTML = 'We accpet master, visa and dicover card only.';

			}



			$('#buttonAddress').prop('disabled', false);

			$('#buttonAddress').css('background-color', '#9E005D');

		}

	});



	/**var cleavePhone = new Cleave('.input-phone', {

		phone: true,

		phoneRegionCode: 'US'

	}); */



	var cleaveCvv = new Cleave('#cvv', {

		numeral: true,

		//numeralThousandsGroupStyle: 'thousand'

	});

	console.log(cleaveCvv);



	$.fn.extend({

		clearForm: function(instance){

			console.log('form clearing........')

			instance.reset();

			instance.refresh();

			console.log(instance.$element)

			

			document.getElementById("validCard").style.display = 'none';

			document.getElementById("notvalidCard").style.display = 'none';

			document.getElementById('shipping-address').style.display = "none";

			document.getElementById("errorAmericanCard").style.display = 'none';



			$('#buttonAddress').prop('disabled', true);

			$('#buttonAddress').css('background-color', '#6c757d');



			$("#cardNumber").val("");

			$("#card_holder_name").val("");

			$("#cvv").val("");

			$("#type").val("");

			$("#inputExpDate").val("");

			$("#email").val("");

			$("#confirm_email").val("");

            $("#address_1").val("");

			$("#address_2").val("");

			$("#city").val("");

			$("#state").val("");

			$("#zip").val("");

			$("#shipping_address_1").val("");

			$("#shipping_address_2").val("");

			$("#shipping_city").val("");

			$("#shipping_state").val("");

			$("#shipping_zip").val("");

			$('input[name="optradio"]').prop('checked', false);

			var $radios = $('input:radio[name=optradio]');

			if($radios.is(':checked') === false) {

				$radios.filter('[value=Same]').prop('checked', true);

			}

		},

		clearCardIcon: function(){

			console.log('Card Icon clearing....')

			amex.addClass('transparent');

			visa.addClass('transparent');

			discover.addClass('transparent');

			mastercard.addClass('transparent');

			document.getElementById("errorAmericanCard").style.display = 'none';



		}

	});

	$("#reset").click(function() {

		var instance = $('#addressForm').parsley(parsleyConfig);

		$.fn.clearForm(instance);

		

	});



	$("#allclear").click(function() {

		var instance = $('#addressForm').parsley(parsleyConfig);

		$.fn.clearForm(instance);

	});







	$("#cardNumber").keyup(function () {

		var maxlimit = 19;

		console.log("Input value: " + this.value.length);

		if (this.value.length == maxlimit) {

			console.log("Input value reach max limit: " + this.value.length);

			$(this).next(':input').focus()

			$("#cvv").focus();

			return false;

		}

		if (this.value.length == 0) {

			document.getElementById("validCard").style.display = 'none';

			document.getElementById("notvalidCard").style.display = 'none';

			document.getElementById("errorAmericanCard").style.display = 'none';

			return false;

		}

	});



	$("#cvv").keyup(function () {

		var maxlimit = 3;

		console.log("Input value: " + this.value.length);

		if (this.value.length == maxlimit) {

			console.log("Input value reach max limit: " + this.value.length);

			$(this).next(':input').focus()

			$("#inputExpDate").focus();

			return false;

		}

	});



	$('.optradio').click(function () {

		var radioValue = $("input[name='optradio']:checked").val();

		if (radioValue == 'Same') {

			//window.location.href = "<?php echo base_url("shopping/make_payment"); ?>";

			document.getElementById('shipping-address').style.display = "none";

		} else {

			document.getElementById('shipping-address').style.display = "block";

			//$('#serviceMessage').modal();

		}



	});





	var parsleyConfig = {

		errorsContainer: function (parsleyField) {

			var fieldSet = parsleyField.$element.closest('fieldset');

			if (fieldSet.length > 0) {

				return fieldSet.find('#checkbox-errors');

			}

			return parsleyField;

		}

	};



	$('#buttonAddress').click(function () {

		var formInstance = $('#addressForm').parsley().validate();

		var instance = $('#addressForm').parsley();

		console.log(instance)

		console.log(formInstance)

		console.log(instance.isValid()); // maxlength is 42, so field is valid



		if (instance.isValid()) {



			var cardNumber = $("#cardNumber").val();

			cardNumber = cardNumber.replace(/[^0-9]/g, '');

			var card_holder_name = $("#card_holder_name").val();

			var cvv = $("#cvv").val();

			var type = $("#type").val();

			var inputExpDate = $("#inputExpDate").val();

			var email = $("#email").val();

			var address_1 = $("#address_1").val();

			var address_2 = $("#address_2").val();

			var city = $("#city").val();

			var state = $("#state").val();

			var zip = $("#zip").val();



			var radioValue = $("input[name='optradio']:checked").val();

			if (radioValue == 'Same') {

				//shipping-address

				var shipping_address_1 = $("#address_1").val();

				var shipping_address_2 = $("#address_2").val();

				var shipping_city = $("#city").val();

				var shipping_state = $("#state").val();

				var shipping_zip = $("#zip").val();

			} else {

				//shipping-address

				var shipping_address_1 = $("#shipping_address_1").val();

				var shipping_address_2 = $("#shipping_address_2").val();

				var shipping_city = $("#shipping_city").val();

				var shipping_state = $("#shipping_state").val();

				var shipping_zip = $("#shipping_zip").val();

			}



			var unitPrice = $("#unitPrice").val();

			var quantity = $("#quantity").val();

			var postData = {

				quantity: quantity,

				unitPrice: unitPrice,

				cardNumber: cardNumber,

				card_holder_name: card_holder_name,

				cvv: cvv,

				type: type,

				expiryDate: inputExpDate,

				email: email,

				address_1: address_1,

				address_2: address_2,

				city: city,

				state: state,

				zip: zip,

				shipping_address_1: shipping_address_1,

				shipping_address_2: shipping_address_2,

				shipping_city: shipping_city,

				shipping_state: shipping_state,

				shipping_zip: shipping_zip,

				optradio: radioValue

			}



			$("#loader").show();

			axios.post('/product', JSON.stringify(postData))

				.then((response) => {

					console.log(response);

					if (response.data.status == '201') {

						instance.reset();

						$.fn.clearForm(instance);

						$.fn.clearCardIcon();

						$('#creditCardStatus').text('Success');

						$('#creditCardResponse').text(response.data.messages.success);

						document.getElementById("myModal").style.display = 'none';

						$('#creditCardServiceMessage').modal("show");

					} else if(response.data.status == '500'){

						$('#creditCardStatus').text('Failed');

						$('#creditCardResponse').text('Cannot connect to the server. please try again after some time.');

						$('#creditCardServiceMessage').modal("show");

					} else {

						//document.getElementById("myModal").style.display = 'none';

						$('#creditCardErrorStatus').text('Failed');

						$('#creditCardErrorResponse').text(response.data.messages.success);

						$('#creditCardServiceErrorMessage').modal("show");

					}



					$("#loader").hide();

				}, (error) => {

					console.log(error);

					$("#loader").hide();

					instance.reset();

					$.fn.clearForm(instance);

					$.fn.clearCardIcon();



				});



		}



	});





	$('.cardNumber').keyup(function () {



		var cardNumber = $("#cardNumber").val();

		cardNumber = cardNumber.replace(/[^0-9]/g, '');



		console.log('Enter CardNumber: ' + cardNumber);

		var card = {

			cardNumber: cardNumber

		};

		$.ajax({

			url: "/validateCard/" + cardNumber,

			success: function (data) {

				var data = JSON.parse(data);

				console.log(data);

				console.log(data.status);

				if (data.status == 'VALID') {

					document.getElementById("validCard").style.display = 'block';

					document.getElementById("notvalidCard").style.display = 'none';

					$('#buttonAddress').prop('disabled', false);

					$('#buttonAddress').css('background-color', '#9E005D');

				} else {

					$('#buttonAddress').prop('disabled', true);

					$('#buttonAddress').css('background-color', '#6c757d');

					document.getElementById("validCard").style.display = 'none';

					document.getElementById("notvalidCard").style.display = 'block';

				}





			},

			error: function (xhr, status, error) {

				console.log(error);



			}

		});



	});

	

	



});



function getParameterByName(name, url = window.location.href) {

    name = name.replace(/[\[\]]/g, '\\$&');

    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),

        results = regex.exec(url);

    if (!results) return null;

    if (!results[2]) return '';

    return decodeURIComponent(results[2].replace(/\+/g, ' '));

}